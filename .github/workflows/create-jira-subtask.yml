name: Create Jira Subtask

on:
  issues:
    types: [opened]

jobs:
  create-jira-subtask:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'task')
    
    steps:
      - name: Extract Jira Story Key
        id: extract-jira-key
        run: |
          # ì´ìŠˆ ë³¸ë¬¸ì—ì„œ Jira í‚¤ ì¶”ì¶œ
          JIRA_KEY=$(echo "${{ github.event.issue.body }}" | grep -oE 'PROJ-[0-9]+' | head -1)
          echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
          echo "Found Jira Key: $JIRA_KEY"

      - name: Create Jira Subtask
        if: steps.extract-jira-key.outputs.jira_key != ''
        run: |
          # Jira ì„œë¸ŒíƒœìŠ¤í¬ ìƒì„±
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{
              "fields": {
                "project": {
                  "key": "PROJ"
                },
                "parent": {
                  "key": "${{ steps.extract-jira-key.outputs.jira_key }}"
                },
                "summary": "${{ github.event.issue.title }}",
                "description": {
                  "type": "doc",
                  "version": 1,
                  "content": [
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "GitHub Issue: ${{ github.event.issue.html_url }}"
                        }
                      ]
                    },
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "${{ github.event.issue.body }}"
                        }
                      ]
                    }
                  ]
                },
                "issuetype": {
                  "name": "Sub-task"
                }
              }
            }' \
            https://your-company.atlassian.net/rest/api/3/issue)
          
          echo "Jira Response: $RESPONSE"
          
          # Jira ì´ìŠˆ í‚¤ ì¶”ì¶œ
          JIRA_ISSUE_KEY=$(echo $RESPONSE | jq -r '.key')
          echo "Created Jira Issue: $JIRA_ISSUE_KEY"
          
          # GitHub ì´ìŠˆì— Jira ë§í¬ ëŒ“ê¸€ ì¶”ê°€
          if [ "$JIRA_ISSUE_KEY" != "null" ] && [ "$JIRA_ISSUE_KEY" != "" ]; then
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d '{
                "body": "ğŸ”— **Jira Sub-task ìƒì„± ì™„ë£Œ**\n\n['"$JIRA_ISSUE_KEY"'](https://your-company.atlassian.net/browse/'"$JIRA_ISSUE_KEY"') - '"${{ github.event.issue.title }}"'\n\n> ì´ GitHub ì´ìŠˆì™€ Jira Sub-taskê°€ ìë™ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."
              }'
          fi

      - name: Add GitHub Issue Link to Jira
        if: steps.extract-jira-key.outputs.jira_key != ''
        run: |
          # Jira ì´ìŠˆì— GitHub ë§í¬ ì¶”ê°€ (Web Link)
          curl -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://your-company.atlassian.net/rest/api/3/issue/${{ steps.extract-jira-key.outputs.jira_key }}/remotelink \
            -d '{
              "object": {
                "url": "${{ github.event.issue.html_url }}",
                "title": "GitHub Issue #${{ github.event.issue.number }}",
                "summary": "${{ github.event.issue.title }}",
                "icon": {
                  "url16x16": "https://github.com/favicon.ico"
                }
              }
            }'
