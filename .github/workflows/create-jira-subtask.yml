name: Create Jira Subtask

on:
  issues:
    types: [opened]

jobs:
  create-jira-subtask:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'task')
    
    steps:
      - name: Extract and Build Jira Story Key
        id: extract-jira-key
        run: |
          echo "Extracting story number from issue body..."
          echo "Issue body: ${{ github.event.issue.body }}"
          
          # ìˆ«ìë§Œ ì¶”ì¶œ
          STORY_NUMBER=$(echo "${{ github.event.issue.body }}" | grep -oE '[0-9]+' | head -1)
          
          if [ -z "$STORY_NUMBER" ]; then
            echo "âŒ No story number found in issue body"
            exit 1
          fi
          
          # PP- ì ‘ë‘ì‚¬ ì¶”ê°€
          JIRA_KEY="PP-$STORY_NUMBER"
          
          echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
          echo "âœ… Built Jira Key: $JIRA_KEY (from number: $STORY_NUMBER)"

      - name: Validate Jira Story exists
        id: validate-story
        run: |
          echo "Validating Jira Story: ${{ steps.extract-jira-key.outputs.jira_key }}"
          
          # Jira Storyê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ steps.extract-jira-key.outputs.jira_key }}")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Jira Story not found: ${{ steps.extract-jira-key.outputs.jira_key }}"
            
            # GitHub ì´ìŠˆì— ì˜¤ë¥˜ ëŒ“ê¸€ ì¶”ê°€
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d '{
                "body": "âŒ **Jira Storyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤**\n\n`${{ steps.extract-jira-key.outputs.jira_key }}`\n\në‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n- Story ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥¸ì§€ (ì˜ˆ: 15)\n- í•´ë‹¹ Storyê°€ Jiraì— ì¡´ì¬í•˜ëŠ”ì§€"
              }'
            exit 1
          fi
          
          echo "âœ… Jira Story validated: ${{ steps.extract-jira-key.outputs.jira_key }}"

      - name: Create Jira Subtask
        run: |
          echo "Creating Jira Sub-task for story: ${{ steps.extract-jira-key.outputs.jira_key }}"
          
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{
              "fields": {
                "project": {
                  "key": "PP"
                },
                "parent": {
                  "key": "${{ steps.extract-jira-key.outputs.jira_key }}"
                },
                "summary": "${{ github.event.issue.title }}",
                "description": "GitHub Issue: ${{ github.event.issue.html_url }}\n\n${{ github.event.issue.body }}",
                "issuetype": {
                  "name": "Sub-task"
                }
              }
            }' \
            ${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue)
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" = "201" ]; then
            JIRA_ISSUE_KEY=$(echo $RESPONSE_BODY | jq -r '.key')
            echo "âœ… Created Jira Sub-task: $JIRA_ISSUE_KEY"
            
            # GitHub ì´ìŠˆì— ì„±ê³µ ëŒ“ê¸€ ì¶”ê°€
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d '{
                "body": "ğŸ”— **Jira Sub-task ìƒì„± ì™„ë£Œ**\n\n**Sub-task:** ['"$JIRA_ISSUE_KEY"']('"${{ secrets.JIRA_BASE_URL }}"'/browse/'"$JIRA_ISSUE_KEY"')\n**Parent Story:** ['"${{ steps.extract-jira-key.outputs.jira_key }}"']('"${{ secrets.JIRA_BASE_URL }}"'/browse/'"${{ steps.extract-jira-key.outputs.jira_key }}"')\n\n> ì´ GitHub ì´ìŠˆì™€ Jira Sub-taskê°€ ìë™ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."
              }'
          else
            echo "âŒ Failed to create Jira Sub-task"
            echo "Error response: $RESPONSE_BODY"
            
            # GitHub ì´ìŠˆì— ì˜¤ë¥˜ ëŒ“ê¸€ ì¶”ê°€
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d '{
                "body": "âŒ **Jira Sub-task ìƒì„± ì‹¤íŒ¨**\n\nHTTP Code: '"$HTTP_CODE"'\n\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ Jira ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
              }'
            exit 1
          fi

      - name: Add GitHub Issue Link to Jira
        run: |
          # Jira ì´ìŠˆì— GitHub ë§í¬ ì¶”ê°€
          curl -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Content-Type: application/json" \
            ${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ steps.extract-jira-key.outputs.jira_key }}/remotelink \
            -d '{
              "object": {
                "url": "${{ github.event.issue.html_url }}",
                "title": "GitHub Issue #${{ github.event.issue.number }}",
                "summary": "${{ github.event.issue.title }}",
                "icon": {
                  "url16x16": "https://github.com/favicon.ico"
                }
              }
            }'
