name: Sync Project Status to Jira

on:
  project_card:
    types: [moved, created]
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  sync-status:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get Project Card Info
        id: get-card-info
        if: github.event_name == 'project_card'
        run: |
          # í”„ë¡œì íŠ¸ ì¹´ë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          CARD_RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.event.project_card.url }}")
          
          echo "Card Response:"
          echo "$CARD_RESPONSE"
          
          # ì—°ê²°ëœ ì´ìŠˆ URL ì¶”ì¶œ
          CONTENT_URL=$(echo "$CARD_RESPONSE" | jq -r '.content_url // empty')
          
          if [ -z "$CONTENT_URL" ]; then
            echo "âŒ No linked issue found"
            exit 0
          fi
          
          # ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
          ISSUE_NUMBER=$(echo "$CONTENT_URL" | grep -oE '[0-9]+$')
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… Found Issue: #$ISSUE_NUMBER"

      - name: Get Column Name
        id: get-column
        if: github.event_name == 'project_card' && steps.get-card-info.outputs.issue_number
        run: |
          # ì¹¼ëŸ¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          COLUMN_RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.event.project_card.column_url }}")
          
          COLUMN_NAME=$(echo "$COLUMN_RESPONSE" | jq -r '.name')
          
          echo "column_name=$COLUMN_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Column Name: $COLUMN_NAME"
          
          # Jira ìƒíƒœ ë§¤í•‘
          case "$COLUMN_NAME" in
            "Todo"|"To Do"|"í•  ì¼")
              JIRA_STATUS="í•  ì¼"
              TRANSITION_NAME="í•  ì¼"
              ;;
            "In Progress"|"ì§„í–‰ ì¤‘"|"In progress")
              JIRA_STATUS="ì§„í–‰ ì¤‘"
              TRANSITION_NAME="ì§„í–‰ ì¤‘"
              ;;
            "Done"|"ì™„ë£Œ")
              JIRA_STATUS="ì™„ë£Œ"
              TRANSITION_NAME="ì™„ë£Œ"
              ;;
            *)
              JIRA_STATUS=""
              TRANSITION_NAME=""
              ;;
          esac
          
          echo "jira_status=$JIRA_STATUS" >> $GITHUB_OUTPUT
          echo "transition_name=$TRANSITION_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Mapped to Jira Status: $JIRA_STATUS"

      - name: Find Jira Issue
        id: find-jira
        if: steps.get-column.outputs.jira_status
        run: |
          # ì´ìŠˆ ë²ˆí˜¸ ì„¤ì •
          if [ "${{ github.event_name }}" = "project_card" ]; then
            ISSUE_NUMBER="${{ steps.get-card-info.outputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          
          echo "Looking for Jira issue in GitHub issue #$ISSUE_NUMBER"
          
          # GitHub ì´ìŠˆì˜ ëŒ“ê¸€ì—ì„œ Jira ë§í¬ ì°¾ê¸°
          COMMENTS_RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments)
          
          # Jira í•˜ìœ„ ì‘ì—… í‚¤ ì¶”ì¶œ
          JIRA_ISSUE_KEY=$(echo "$COMMENTS_RESPONSE" | jq -r '.[].body' | grep -oE 'PP-[0-9]+' | head -1)
          
          if [ -z "$JIRA_ISSUE_KEY" ]; then
            echo "âŒ No Jira issue found in comments"
            exit 0
          fi
          
          echo "jira_issue_key=$JIRA_ISSUE_KEY" >> $GITHUB_OUTPUT
          echo "âœ… Found Jira Issue: $JIRA_ISSUE_KEY"

      - name: Get Available Transitions
        id: get-transitions
        if: steps.find-jira.outputs.jira_issue_key
        run: |
          JIRA_KEY="${{ steps.find-jira.outputs.jira_issue_key }}"
          
          # í˜„ì¬ ìƒíƒœ í™•ì¸
          CURRENT_RESPONSE=$(curl -s \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$JIRA_KEY")
          
          CURRENT_STATUS=$(echo "$CURRENT_RESPONSE" | jq -r '.fields.status.name')
          echo "current_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT
          echo "âœ… Current Status: $CURRENT_STATUS"
          
          # ì›í•˜ëŠ” ìƒíƒœì™€ ê°™ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
          TARGET_STATUS="${{ steps.get-column.outputs.jira_status }}"
          if [ "$CURRENT_STATUS" = "$TARGET_STATUS" ]; then
            echo "âœ… Already in target status: $TARGET_STATUS"
            exit 0
          fi
          
          # ì‚¬ìš© ê°€ëŠ¥í•œ ì „í™˜ ì¡°íšŒ
          TRANSITIONS_RESPONSE=$(curl -s \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$JIRA_KEY/transitions")
          
          echo "Available transitions:"
          echo "$TRANSITIONS_RESPONSE" | jq '.transitions[] | {id: .id, name: .name}'
          
          # ì›í•˜ëŠ” ì „í™˜ ID ì°¾ê¸°
          TRANSITION_ID=$(echo "$TRANSITIONS_RESPONSE" | jq -r ".transitions[] | select(.name | test(\"${{ steps.get-column.outputs.transition_name }}\"; \"i\")) | .id" | head -1)
          
          if [ -z "$TRANSITION_ID" ] || [ "$TRANSITION_ID" = "null" ]; then
            echo "âŒ No transition found for: ${{ steps.get-column.outputs.transition_name }}"
            exit 0
          fi
          
          echo "transition_id=$TRANSITION_ID" >> $GITHUB_OUTPUT
          echo "âœ… Found Transition ID: $TRANSITION_ID"

      - name: Update Jira Status
        if: steps.get-transitions.outputs.transition_id
        run: |
          JIRA_KEY="${{ steps.find-jira.outputs.jira_issue_key }}"
          TRANSITION_ID="${{ steps.get-transitions.outputs.transition_id }}"
          TARGET_STATUS="${{ steps.get-column.outputs.jira_status }}"
          CURRENT_STATUS="${{ steps.get-transitions.outputs.current_status }}"
          
          echo "Updating Jira Issue: $JIRA_KEY"
          echo "From: $CURRENT_STATUS â†’ To: $TARGET_STATUS"
          echo "Transition ID: $TRANSITION_ID"
          
          # Jira ìƒíƒœ ë³€ê²½
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"transition\":{\"id\":\"$TRANSITION_ID\"}}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$JIRA_KEY/transitions")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ "$HTTP_CODE" = "204" ]; then
            echo "âœ… Successfully updated Jira status: $JIRA_KEY â†’ $TARGET_STATUS"
            
            # GitHub ì´ìŠˆì— ëŒ“ê¸€ ì¶”ê°€
            ISSUE_NUMBER="${{ steps.get-card-info.outputs.issue_number || github.event.issue.number }}"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
              -d '{
                "body": "ğŸ”„ **Jira ìƒíƒœ ë™ê¸°í™”**\n\n['"$JIRA_KEY"']('"${{ secrets.JIRA_BASE_URL }}"'/browse/'"$JIRA_KEY"') ìƒíƒœê°€ **'"$TARGET_STATUS"'**ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n> GitHub Projectsì˜ ì¹¼ëŸ¼ ì´ë™ìœ¼ë¡œ ìë™ ì²˜ë¦¬ë¨"
              }'
          else
            echo "âŒ Failed to update Jira status"
            echo "Response: $RESPONSE"
          fi
