name: Sync Project Status to Jira

on:
  schedule:
    - cron: '*/15 * * * *'  # 15ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  issues: write
  contents: read

jobs:
  sync-status:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get Recent Issues
        id: get-issues
        run: |
          # ìµœê·¼ ì—…ë°ì´íŠ¸ëœ open ì´ìŠˆë“¤ ê°€ì ¸ì˜¤ê¸°
          ISSUES_RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open&sort=updated&per_page=5")
          
          # ì´ìŠˆ ë²ˆí˜¸ë“¤ ì¶”ì¶œ
          ISSUE_NUMBERS=$(echo "$ISSUES_RESPONSE" | jq -r '.[].number')
          
          echo "Recent issues: $ISSUE_NUMBERS"
          echo "issue_numbers<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check Project Status for Each Issue
        run: |
          ISSUE_NUMBERS="${{ steps.get-issues.outputs.issue_numbers }}"
          
          for ISSUE_NUMBER in $ISSUE_NUMBERS; do
            echo "=== Checking issue #$ISSUE_NUMBER ==="
            
            # GraphQL ì¿¼ë¦¬ (ì˜¬ë°”ë¥¸ JSON í˜•ì‹)
            QUERY_JSON=$(jq -n \
              --arg owner "${{ github.repository_owner }}" \
              --arg repo "$(echo '${{ github.repository }}' | cut -d'/' -f2)" \
              --argjson issueNumber "$ISSUE_NUMBER" \
              '{
                query: "query($owner: String!, $repo: String!, $issueNumber: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issueNumber) {
                      number
                      title
                      projectItems(first: 10) {
                        nodes {
                          id
                          fieldValues(first: 10) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                name
                                field {
                                  ... on ProjectV2FieldCommon {
                                    name
                                  }
                                }
                              }
                            }
                          }
                          project {
                            title
                            number
                          }
                        }
                      }
                    }
                  }
                }",
                variables: {
                  owner: $owner,
                  repo: $repo,
                  issueNumber: $issueNumber
                }
              }')
            
            echo "Sending GraphQL query:"
            echo "$QUERY_JSON" | jq '.'
            
            PROJECT_RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "$QUERY_JSON" \
              https://api.github.com/graphql)
            
            echo "GraphQL response:"
            echo "$PROJECT_RESPONSE" | jq '.'
            
            # ì˜¤ë¥˜ ì²´í¬
            if echo "$PROJECT_RESPONSE" | jq -e '.errors' > /dev/null; then
              echo "âŒ GraphQL Error for issue #$ISSUE_NUMBER"
              echo "$PROJECT_RESPONSE" | jq '.errors'
              continue
            fi
            
            # Status í•„ë“œ ê°’ ì¶”ì¶œ
            STATUS=$(echo "$PROJECT_RESPONSE" | jq -r '
              .data.repository.issue.projectItems.nodes[]? |
              .fieldValues.nodes[]? |
              select(.field.name == "Status") |
              .name // empty
            ' | head -1)
            
            if [ -n "$STATUS" ] && [ "$STATUS" != "null" ]; then
              echo "âœ… Issue #$ISSUE_NUMBER Status: $STATUS"
              
              # Jira ìƒíƒœ ë§¤í•‘ ë° ì—…ë°ì´íŠ¸
              case "$STATUS" in
                "Todo"|"To Do"|"í•  ì¼")
                  echo "Mapping to: í•  ì¼"
                  bash -c "./update_jira_status.sh '$ISSUE_NUMBER' 'í•  ì¼'"
                  ;;
                "In Progress"|"ì§„í–‰ ì¤‘")
                  echo "Mapping to: ì§„í–‰ ì¤‘"  
                  bash -c "./update_jira_status.sh '$ISSUE_NUMBER' 'ì§„í–‰ ì¤‘'"
                  ;;
                "Done"|"ì™„ë£Œ")
                  echo "Mapping to: ì™„ë£Œ"
                  bash -c "./update_jira_status.sh '$ISSUE_NUMBER' 'ì™„ë£Œ'"
                  ;;
                *)
                  echo "âš ï¸ Unknown status: $STATUS"
                  ;;
              esac
            else
              echo "â„¹ï¸ No project status found for issue #$ISSUE_NUMBER"
            fi
            
            echo "---"
          done

      - name: Create Jira Update Script
        run: |
          cat > update_jira_status.sh << 'EOF'
          #!/bin/bash
          ISSUE_NUMBER=$1
          TARGET_STATUS=$2
          
          echo "ğŸ”„ Updating Jira status for issue #$ISSUE_NUMBER to '$TARGET_STATUS'"
          
          # GitHub ì´ìŠˆì˜ ëŒ“ê¸€ì—ì„œ Jira ë§í¬ ì°¾ê¸°
          COMMENTS_RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments)
          
          # Jira ì´ìŠˆ í‚¤ ì¶”ì¶œ
          JIRA_ISSUE_KEY=$(echo "$COMMENTS_RESPONSE" | jq -r '.[].body // ""' | grep -oE 'PP-[0-9]+' | head -1)
          
          if [ -z "$JIRA_ISSUE_KEY" ]; then
            echo "âŒ No Jira issue found for #$ISSUE_NUMBER"
            exit 0
          fi
          
          echo "ğŸ“ Found Jira issue: $JIRA_ISSUE_KEY"
          
          # í˜„ì¬ ìƒíƒœ í™•ì¸
          CURRENT_RESPONSE=$(curl -s \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$JIRA_ISSUE_KEY")
          
          if ! echo "$CURRENT_RESPONSE" | jq -e '.fields' > /dev/null; then
            echo "âŒ Failed to get Jira issue details"
            exit 0
          fi
          
          CURRENT_STATUS=$(echo "$CURRENT_RESPONSE" | jq -r '.fields.status.name')
          
          if [ "$CURRENT_STATUS" = "$TARGET_STATUS" ]; then
            echo "âœ… Already in correct status: $TARGET_STATUS"
            exit 0
          fi
          
          echo "ğŸ”„ Current: $CURRENT_STATUS â†’ Target: $TARGET_STATUS"
          
          # ì „í™˜ ê°€ëŠ¥í•œ ìƒíƒœ ì¡°íšŒ
          TRANSITIONS_RESPONSE=$(curl -s \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$JIRA_ISSUE_KEY/transitions")
          
          # ì›í•˜ëŠ” ì „í™˜ ID ì°¾ê¸°
          TRANSITION_ID=$(echo "$TRANSITIONS_RESPONSE" | jq -r ".transitions[]? | select(.name | test(\"$TARGET_STATUS\"; \"i\")) | .id" | head -1)
          
          if [ -z "$TRANSITION_ID" ] || [ "$TRANSITION_ID" = "null" ]; then
            echo "âŒ No transition found for: $TARGET_STATUS"
            echo "Available transitions:"
            echo "$TRANSITIONS_RESPONSE" | jq -r '.transitions[]? | "- \(.name) (ID: \(.id))"'
            exit 0
          fi
          
          echo "ğŸ¯ Found transition ID: $TRANSITION_ID"
          
          # ìƒíƒœ ë³€ê²½
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            -H "Authorization: Basic ${{ secrets.JIRA_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"transition\":{\"id\":\"$TRANSITION_ID\"}}" \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$JIRA_ISSUE_KEY/transitions")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ "$HTTP_CODE" = "204" ]; then
            echo "âœ… Successfully updated $JIRA_ISSUE_KEY: $CURRENT_STATUS â†’ $TARGET_STATUS"
          else
            echo "âŒ Failed to update $JIRA_ISSUE_KEY"
            echo "Response: $(echo "$RESPONSE" | sed '/HTTP_CODE:/d')"
          fi
          EOF
          
          chmod +x update_jira_status.sh
